rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Reglas para productos - Solo lectura pública, escritura para admins
    match /productos/{productId} {
      // Permitir lectura a todos (para mostrar productos)
      allow read: if true;
      
      // Solo admins pueden escribir/modificar productos
      allow write: if request.auth != null && 
                   get(/databases/$(database)/documents/usuarios/$(request.auth.uid)).data.admin == true;
    }
    
    // Reglas para categorías - Solo lectura pública, escritura para admins
    match /categorias/{categoryId} {
      allow read: if true;
      allow write: if request.auth != null && 
                   get(/databases/$(database)/documents/usuarios/$(request.auth.uid)).data.admin == true;
    }
    
    // Reglas para usuarios - Solo el propio usuario y admins
    match /usuarios/{userId} {
      // Usuarios pueden leer/escribir sus propios datos
      allow read, write: if request.auth != null && request.auth.uid == userId;
      
      // Admins pueden leer/escribir cualquier usuario
      allow read, write: if request.auth != null && 
                         get(/databases/$(database)/documents/usuarios/$(request.auth.uid)).data.admin == true;
    }
    
    // Reglas para pedidos - Solo el usuario propietario y admins
    match /pedidos/{orderId} {
      allow read, write: if request.auth != null && 
                         (resource.data.userId == request.auth.uid || 
                          get(/databases/$(database)/documents/usuarios/$(request.auth.uid)).data.admin == true);
    }
    
    // Reglas para carritos - Solo el usuario propietario
    match /carritos/{cartId} {
      allow read, write: if request.auth != null && request.auth.uid == cartId;
    }
    
    // Denegar acceso a cualquier otra colección
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
